name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚v2.1.1
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests>=2.28.0
        pip install lxml>=4.9.0
        pip install psutil>=5.9.0
        pip install cryptography>=3.4.8
        pip install pyinstaller>=5.0

    - name: Create simple build script
      run: |
        echo 'import os, sys, subprocess, shutil, zipfile, re' > simple_build.py
        echo 'from datetime import datetime' >> simple_build.py
        echo '' >> simple_build.py
        echo 'def get_version():' >> simple_build.py
        echo '    try:' >> simple_build.py
        echo '        result = subprocess.run(["git", "describe", "--tags", "--abbrev=0"], capture_output=True, text=True)' >> simple_build.py
        echo '        return result.stdout.strip() if result.returncode == 0 else "v2.1.1"' >> simple_build.py
        echo '    except:' >> simple_build.py
        echo '        return "v2.1.1"' >> simple_build.py
        echo '' >> simple_build.py
        echo 'def main():' >> simple_build.py
        echo '    print("Building Windows executable...")' >> simple_build.py
        echo '    cmd = [sys.executable, "-m", "PyInstaller", "--onedir", "--console", "--name", "äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ", "main.py"]' >> simple_build.py
        echo '    subprocess.run(cmd, check=True)' >> simple_build.py
        echo '    ' >> simple_build.py
        echo '    version = get_version()' >> simple_build.py
        echo '    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")' >> simple_build.py
        echo '    zip_name = f"äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ_{version}_å®Œæ•´ç‰ˆ_{timestamp}.zip"' >> simple_build.py
        echo '    ' >> simple_build.py
        echo '    with zipfile.ZipFile(zip_name, "w", zipfile.ZIP_DEFLATED) as zipf:' >> simple_build.py
        echo '        for root, dirs, files in os.walk("dist/äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ"):' >> simple_build.py
        echo '            for file in files:' >> simple_build.py
        echo '                file_path = os.path.join(root, file)' >> simple_build.py
        echo '                arc_path = os.path.relpath(file_path, "dist")' >> simple_build.py
        echo '                zipf.write(file_path, arc_path)' >> simple_build.py
        echo '        zipf.write("config.ini", "äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ/config.ini")' >> simple_build.py
        echo '        zipf.write("README.md", "äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ/README.md")' >> simple_build.py
        echo '    print(f"Created: {zip_name}")' >> simple_build.py
        echo '' >> simple_build.py
        echo 'if __name__ == "__main__":' >> simple_build.py
        echo '    main()' >> simple_build.py

    - name: Build Windows executable
      run: |
        python simple_build.py
        
    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Triggered by tag: $VERSION"
        else
          # å¦‚æœä¸æ˜¯æ ‡ç­¾è§¦å‘ï¼Œè·å–æœ€æ–°æ ‡ç­¾æˆ–ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v2.1.1")
          echo "Not triggered by tag, using latest tag: $VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Final version: $VERSION"
        
    - name: Find ZIP file
      id: find_zip
      shell: bash
      run: |
        ZIP_FILE=$(ls äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ_v*_å®Œæ•´ç‰ˆ_*.zip | head -1)
        echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
        echo "Found ZIP file: $ZIP_FILE"
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ ${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ‰ äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ ${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½ `äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ_${{ steps.get_version.outputs.version }}_å®Œæ•´ç‰ˆ.zip`
          - è§£å‹åˆ°ä»»æ„ç›®å½•
          - ç¼–è¾‘ `config.ini` é…ç½®æ–‡ä»¶
          - åŒå‡» `äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ.exe` è¿è¡Œ
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ” **æ™ºèƒ½ç™»å½•**: æ”¯æŒäº¬ä¸œæ–°ç‰ˆCookieæ ¼å¼ï¼Œè‡ªåŠ¨è¯†åˆ«ç™»å½•çŠ¶æ€
          - ğŸ–¼ï¸ **äºŒç»´ç è‡ªåŠ¨å…³é—­**: æ‰«ç å®Œæˆåè‡ªåŠ¨å…³é—­äºŒç»´ç çª—å£
          - ğŸ“± **å¢å¼ºé€šçŸ¥**: è¯¦ç»†çš„markdownæ ¼å¼é€šçŸ¥ï¼ŒåŒ…å«å®Œæ•´ä¿¡æ¯
          - âš¡ **å…¨è‡ªåŠ¨åŒ–**: é¢„çº¦+æŠ¢è´­ä¸€ä½“åŒ–ï¼Œ7x24å°æ—¶æ— äººå€¼å®ˆ
          - ğŸ›¡ï¸ **å®‰å…¨ç­–ç•¥**: å¤šçº§é£æ§ç­–ç•¥ï¼Œä¿æŠ¤è´¦æˆ·å®‰å…¨
          
          ### ğŸ”§ æŠ€æœ¯æ”¹è¿›
          - æ”¯æŒWindows 10/11é»˜è®¤ç…§ç‰‡åº”ç”¨è‡ªåŠ¨å…³é—­
          - å…¼å®¹ä¼ ç»Ÿå’Œæ–°ç‰ˆäº¬ä¸œCookieæ ¼å¼
          - æ™ºèƒ½é”™è¯¯æ¢å¤å’Œå¼‚å¸¸å¤„ç†
          - å®Œå–„çš„ç”¨æˆ·ä½“éªŒå’Œæ“ä½œæŒ‡å¼•
          
          ### âš ï¸ ä½¿ç”¨æé†’
          - é¦–æ¬¡ä½¿ç”¨å»ºè®®é€‰æ‹©ä¿å®ˆç­–ç•¥æµ‹è¯•
          - è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹å‹ç¼©åŒ…å†…çš„æ–‡æ¡£
          - å¦‚é‡é—®é¢˜è¯·æŸ¥çœ‹bugä¿®å¤.mdæ–‡æ¡£
          
          ---
          **ç³»ç»Ÿè¦æ±‚**: Windows 10/11 x64
          **æ— éœ€å®‰è£…**: è§£å‹å³ç”¨ï¼ŒåŒ…å«å®Œæ•´è¿è¡Œç¯å¢ƒ
        draft: false
        prerelease: false
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_zip.outputs.zip_file }}
        asset_name: äº¬ä¸œèŒ…å°ç§’æ€ç³»ç»Ÿ_${{ steps.get_version.outputs.version }}_å®Œæ•´ç‰ˆ.zip
        asset_content_type: application/zip
