# 🤖 全自动化京东秒杀系统

一个功能完善的京东商品秒杀工具，支持预约、秒杀、全自动化执行等功能。

## ✨ 主要特性

- 🎯 **三种执行模式**：预约商品、秒杀抢购、全自动化执行
- 🤖 **全自动化模式**：预约+秒杀一体化，无人值守运行
- 🔐 **智能登录维护**：自动检测登录状态，过期时自动重新登录
- ⏰ **精确时间同步**：多重备选时间源，毫秒级时间控制
- 🛡️ **三级安全策略**：保守/平衡/激进三种风控安全等级
- 🎭 **人类行为模拟**：智能重试间隔，模拟真实用户操作
- 🚨 **风控检测防护**：实时监控风控信号，自动应对策略
- 📱 **多渠道通知**：控制台显示 + 微信推送（Server酱）
- 📊 **实时状态监控**：清晰的状态面板和进度提示
- ⚙️ **配置自动化**：启动前自动检查配置完整性

## 🚀 快速开始

### 环境要求

- Python 3.8+
- 稳定的网络连接

## 📦 Windows EXE版本 🆕

**推荐使用**：无需安装Python环境，开箱即用！

### 下载使用
1. 下载最新的ZIP包：`京东茅台秒杀系统_v2.1.0_完整版.zip`
2. 解压到任意目录
3. 编辑 `config.ini` 配置文件（重要！）
4. 双击 `京东茅台秒杀系统.exe` 运行

### EXE版本特点
- ✅ **免安装**：无需Python环境，直接运行
- ✅ **完整功能**：包含所有最新功能和安全策略
- ✅ **便于分发**：可直接发送给其他人使用
- ✅ **文档齐全**：包含完整的使用说明和配置指南

## 📁 项目结构

```
jd_seckill_new/
├── main.py                           # 主程序入口
├── config.ini                        # 配置文件
├── requirements.txt                   # 依赖包列表
├── 打包工具.py                        # Windows EXE打包工具
├── maotai/                           # 核心功能模块
│   ├── jd_spider_requests.py         # 主要业务逻辑
│   ├── timer.py                      # 时间同步
│   ├── config.py                     # 配置管理
│   └── jd_logger.py                  # 日志管理
├── helper/                           # 辅助功能
│   └── jd_helper.py                  # 工具函数
├── error/                            # 异常处理
│   └── exception.py                  # 自定义异常
├── cookies/                          # 登录信息存储
├── test_*.py                         # 测试脚本
├── README.md                         # 项目说明
├── bug修复.md                        # 问题解决方案
├── 京东风控机制分析与安全策略.md        # 安全策略详解
└── 极高概率抢购方案.md                # 高级抢购策略
```

## 🛠️ 开发者安装（源码版本）

### 安装步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/your-repo/jd_seckill_new.git
   cd jd_seckill_new
   ```

2. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

   如果安装较慢，可使用清华源：
   ```bash
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
   ```

3. **配置参数**

   编辑 `config.ini` 文件，填写必要配置：

   ```ini
   [config]
   # 商品ID（从商品页面URL获取）
   sku_id = 100012043978

   # 抢购时间（精确到毫秒）
   buy_time = 09:59:59.500

   # 京东风控参数（必须填写）
   eid = your_eid_here
   fp = your_fp_here

   # 风控安全策略（新增）
   risk_level = BALANCED
   max_processes = 8
   max_retries = 100

   [messenger]
   # 微信推送开关
   enable = true
   # Server酱密钥
   sckey = your_sckey_here
   ```

4. **运行程序**
   ```bash
   python main.py
   ```

## 📖 详细配置说明

### 必需配置项

#### 1. 商品ID (sku_id)
从京东商品页面URL获取，例如：
- 商品页面：`https://item.jd.com/100012043978.html`
- sku_id：`100012043978`

#### 2. 风控参数 (eid & fp)
获取方法：
1. 打开京东商城，随便找一个商品
2. 加入购物车，进入结算页面
3. 打开浏览器开发者工具（F12）
4. 切换到控制台（Console）
5. 输入 `_JdTdudfp` 并回车
6. 从输出的JSON中获取 `eid` 和 `fp` 值

#### 3. 抢购时间 (buy_time)
格式：`HH:MM:SS.fff`（精确到毫秒）
- 例如：`11:59:59.200` 表示提前800ms开始抢购

#### 4. 风控安全策略 (risk_level) 🆕
选择适合的安全等级：
- `CONSERVATIVE`: 保守策略，风控风险极低，适合新手
- `BALANCED`: 平衡策略，推荐大多数用户使用
- `AGGRESSIVE`: 激进策略，高成功率但风控风险较高

### 可选配置项

#### 微信推送 (messenger)
支持Server酱推送服务：
1. 关注"Server酱"微信公众号
2. 获取SCKEY密钥
3. 在配置文件中设置：
   ```ini
   [messenger]
   enable = true
   sckey = SCT283354TAVZ68H2gfMfTdCuw9UiO7Oml
   ```

## 🎯 使用方法

### 功能选择

运行程序后，会显示功能菜单：

```
功能列表：
 1.预约商品
 2.秒杀抢购商品
 3.全自动化执行（预约+秒杀）🤖
```

### 模式说明

#### 1. 预约模式
- 适用于需要预约的商品（如茅台）
- 程序会在指定时间自动执行预约
- 预约成功后程序结束

#### 2. 秒杀模式
- 适用于直接秒杀的商品
- 程序会在指定时间开始抢购
- 支持多进程并发提高成功率

#### 3. 全自动化模式 🌟
- **推荐使用**：一键启动，无需人工干预
- 智能判断当前时间，自动执行预约或秒杀
- 自动处理登录过期问题
- 支持跨天连续运行
- 实时状态监控和通知

### 登录流程

首次使用或登录过期时：
1. 程序会自动弹出二维码
2. 使用京东APP扫描二维码
3. 确认登录后程序自动继续

## 🔧 高级功能

### 🛡️ 三级安全策略 🆕

系统提供三种风控安全等级，在成功率和安全性之间找到最佳平衡：

#### 🟢 保守策略 (CONSERVATIVE)
- **适用人群**: 新手用户、小白信用<70分
- **并发进程**: 3个
- **重试间隔**: 500-2000ms
- **时间提前**: 200ms
- **风控风险**: 极低
- **预期成功率**: 40-60%

#### 🟡 平衡策略 (BALANCED) - 推荐
- **适用人群**: 大多数用户、小白信用70-90分
- **并发进程**: 8个
- **重试间隔**: 100-1000ms
- **时间提前**: 800ms
- **风控风险**: 低
- **预期成功率**: 60-80%

#### 🔴 激进策略 (AGGRESSIVE)
- **适用人群**: 高信用用户、小白信用>90分
- **并发进程**: 15个
- **重试间隔**: 50-500ms
- **时间提前**: 1200ms
- **风控风险**: 中高
- **预期成功率**: 80-95%

### 🎭 人类行为模拟 🆕

系统智能模拟真实用户行为，有效降低风控检测概率：

#### 智能重试机制
- **随机间隔**: 根据错误类型智能调整重试时间
- **疲劳因子**: 重试次数越多，间隔越长
- **渐进加速**: 越接近秒杀时间，重试越快

#### 行为特征模拟
- **页面停留**: 1-3秒随机停留时间
- **操作间隔**: 模拟真实用户的操作节奏
- **连接预热**: 安全的网络连接预热机制

### 🚨 风控检测与防护 🆕

#### 实时风控监控
- **错误识别**: 自动识别风控相关错误
- **信号检测**: 实时监控风控预警信号
- **风险评估**: 动态评估当前风控风险等级

#### 自动应对策略
- **降频处理**: 检测到风控时自动降低请求频率
- **行为模拟**: 启动人类浏览行为模拟
- **冷却等待**: 智能等待风控信号消除

### 全自动化模式详解

全自动化模式是本系统的核心功能，具有以下特性：

#### 智能时间管理
- 自动判断当前时间段应该执行什么操作
- 距离预约时间超过1小时：等待预约时间
- 距离预约时间不到1小时：执行预约
- 在秒杀时间段内：执行秒杀
- 秒杀结束后：等待明天

#### 自动登录维护
- 每5分钟检查一次登录状态
- 检测到登录过期时自动弹出二维码
- 用户扫码后程序自动继续运行
- 支持多种登录状态验证方式

#### 增强错误处理
- 网络连接异常：自动重试，递增等待时间
- 请求超时：自动重试，最多3次
- JSON解析错误：支持JSONP格式，自动适配
- 接口失效：自动检测并尝试备选方案

#### 实时状态监控
```
🤖 全自动化模式 - 状态面板
⏰ 当前时间: 2025-06-20 17:00:00
📊 当前状态: 距离预约时间还有 16小时59分钟
🎯 下一步操作: 等待预约时间
⏳ 剩余时间: 16:59:23
📋 预约状态: ⏳ 待执行
🔥 秒杀状态: ⏳ 待执行
🔐 登录状态: ✅ 已登录
👤 当前用户: jd_username
```

### 通知系统

支持多种通知方式：

#### 控制台通知
- 实时状态更新
- 操作结果提示
- 错误警告信息

#### 微信推送（Server酱）
- 系统启动通知
- 登录状态变更
- 预约成功/失败
- 秒杀结果通知
- 异常情况警告

### 时间同步机制

程序采用多重备选时间源：
1. 京东页面服务器时间（主要）
2. 世界时钟API（备选）
3. 淘宝时间API（备选）
4. 本地时间（最后备选）

时间精度可达毫秒级，确保抢购时机准确。

## 🛠️ 故障排除

### 常见问题

#### 1. 程序启动闪退
**原因**：时间同步接口失效
**解决**：程序已自动修复，使用多重备选时间源

#### 2. 登录二维码不显示
**原因**：图片查看器未正确配置
**解决**：手动打开项目目录下的 `qr_code.png` 文件

#### 3. 预约功能报JSON解析错误
**原因**：京东接口返回格式变更
**解决**：程序已增强JSON解析，支持多种格式

#### 4. 微信推送不工作
**原因**：Server酱配置错误或API变更
**解决**：
- 检查sckey是否正确
- 确认使用正确的API版本（新版用SCT开头）
- 运行测试脚本验证：`python test_wechat_push.py`

#### 5. 登录状态检查失败 🔧 已修复
**原因**：Cookie验证过于严格，不兼容新版Cookie格式
**解决**：程序已完全修复，支持新旧版本Cookie自动识别
- ✅ 支持传统Cookie格式（pt_key, pt_pin）
- ✅ 支持新版Cookie格式（pin, pinId, unick）
- ✅ 智能验证机制，自动适配不同版本

#### 6. 二维码登录成功但程序显示失败 🔧 已修复
**原因**：登录验证逻辑与京东新版Cookie不匹配
**解决**：
- 程序已更新Cookie验证逻辑
- 自动识别新版登录Cookie（pin + pinId）
- 兼容传统登录Cookie（pt_key + pt_pin）
- 登录成功后自动关闭二维码窗口

#### 7. 二维码窗口需要手动关闭 🆕 已优化
**原因**：用户体验不够友好
**解决**：
- 扫码完成后自动关闭二维码窗口
- 减少用户手动操作
- 提升整体使用体验

#### 6. 抢购时出现验证码或操作频繁提示 🆕
**原因**：触发京东风控机制
**解决**：
- 降低风险等级（改为CONSERVATIVE）
- 检查小白信用分是否过低
- 等待24小时后再试
- 提升账户信用和购买记录

#### 7. 账户被限制或功能受限 🆕
**原因**：风控策略过于激进
**解决**：
- 立即停止抢购程序
- 正常使用京东服务一段时间
- 提升小白信用分
- 下次使用更保守的策略

### 测试工具

项目提供多个测试脚本：

```bash
# 测试基础功能
python test_fix.py

# 测试时间同步
python test_time_sync.py

# 测试微信推送
python test_wechat_push.py

# 测试全自动化模式
python test_auto_mode.py

# 打包Windows EXE文件 🆕
python 打包工具.py
```

### 日志分析

程序运行时会生成详细日志，关键信息：
- `INFO`: 正常操作信息
- `WARNING`: 警告信息，程序可继续运行
- `ERROR`: 错误信息，可能影响功能

## 📊 性能优化

### 网络优化
- 使用连接池复用HTTP连接
- 设置合理的超时时间
- 自动重试机制

### 并发优化
- 秒杀模式支持多进程并发
- 合理的请求间隔避免被限制
- 智能的重试策略

### 资源优化
- 及时释放不需要的资源
- 优化内存使用
- 减少不必要的网络请求

## 特别声明

* 本仓库发布的`jd_maotai_seckill`项目中涉及的任何脚本，仅用于测试和学习研究，禁止用于商业用途，不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断。

* 本项目内所有资源文件，禁止任何公众号、自媒体进行任何形式的转载、发布。

* `ChinaVolvocars` 对任何脚本问题概不负责，包括但不限于由任何脚本错误导致的任何损失或损害.

* 间接使用脚本的任何用户，包括但不限于建立VPS或在某些行为违反国家/地区法律或相关法规的情况下进行传播, `ChinaVolvocars` 对于由此引起的任何隐私泄漏或其他后果概不负责。

* 请勿将`jd_maotai_seckill`项目的任何内容用于商业或非法目的，否则后果自负。

* 如果任何单位或个人认为该项目的脚本可能涉嫌侵犯其权利，则应及时通知并提供身份证明，所有权证明，我们将在收到认证文件后删除相关脚本。

* 以任何方式查看此项目的人或直接或间接使用`jd_maotai_seckill`项目的任何脚本的使用者都应仔细阅读此声明。`ChinaVolvocars` 保留随时更改或补充此免责声明的权利。一旦使用并复制了任何相关脚本或`jd_maotai_seckill`项目，则视为您已接受此免责声明。
  
* 您必须在下载后的24小时内从计算机或手机中完全删除以上内容。  
  
* 本项目遵循`GPL-3.0 License`协议，如果本特别声明与`GPL-3.0 License`协议有冲突之处，以本特别声明为准。

> ***您使用或者复制了本仓库且本人制作的任何代码或项目，则视为`已接受`此声明，请仔细阅读***  
> ***您在本声明未发出之时点使用或者复制了本仓库且本人制作的任何代码或项目且此时还在使用，则视为`已接受`此声明，请仔细阅读***

## 简介
通过我这段时间的使用（2020-12-12至2020-12-17），证实这个脚本确实能抢到茅台。我自己三个账号抢了四瓶，帮两个朋友抢了4瓶。
大家只要确认自己配置文件没有问题，Cookie没有失效，坚持下去总能成功的。

根据这段时间大家的反馈，除了茅台，其它不需要加购物车的商品也不能抢。具体原因还没有进行排查，应该是京东非茅台商品抢购流程发生了变化。  
为了避免耽误大家的时间，先不要抢购非茅台商品。  
等这个问题处理好了，会上线新版本。


## 暗中观察

根据12月14日以来抢茅台的日志分析，大胆推断再接再厉返回Json消息中`resultCode`与小白信用的关系。  
这里主要分析出现频率最高的`90016`和`90008`。  

### 样例JSON
```json
{'errorMessage': '很遗憾没有抢到，再接再厉哦。', 'orderId': 0, 'resultCode': 90016, 'skuId': 0, 'success': False}
{'errorMessage': '很遗憾没有抢到，再接再厉哦。', 'orderId': 0, 'resultCode': 90008, 'skuId': 0, 'success': False}
```

### 数据统计

| 案例 | 小白信用 | 90016 | 90008 | 抢到耗时 |
| ---- | ---- | ---- | ---- | ---- |
| 张三 | 63.8 | 59.63% | 40.37% | 暂未抢到 |
| 李四 | 92.9 | 72.05% | 27.94% | 4天 |
| 王五 | 99.6 | 75.70% | 24.29% | 暂未抢到 |
| 赵六 | 103.4 | 91.02% | 8.9% | 2天 |

### 猜测
推测返回90008是京东的风控机制，代表这次请求直接失败，不参与抢购。  
小白信用越低越容易触发京东的风控。  

从数据来看小白信用与风控的关系大概每十分为一个等级，所以赵六基本上没有被拦截，李四和王五的拦截几率相近，张三的拦截几率最高。  

风控放行后才会进行抢购，这时候用的应该是水库计数模型，假设无法一次性拿到所有数据的情况下来尽量的做到抢购成功用户的均匀分布，这样就和概率相关了。  

> 综上，张三想成功有点困难，小白信用是100+的用户成功几率最大。

## 主要功能

- 登陆京东商城（[www.jd.com](http://www.jd.com/)）
  - 用京东APP扫码给出的二维码
- 预约茅台
  - 定时自动预约
- 秒杀预约后等待抢购
  - 定时开始自动抢购

## 运行环境
请安装python 3.8 运行此项目
- [Python 3.8](https://www.python.org/)

## 第三方库

- 需要使用到的库已经放在requirements.txt，使用pip安装的可以使用指令  
`pip install -r requirements.txt`
- 如果国内安装第三方库比较慢，可以使用以下指令进行清华源加速
`pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/`

## 使用教程  
#### 1. 推荐Chrome浏览器
#### 2. 网页扫码登录，或者账号密码登录
#### 3. 填写config.ini配置信息 
(1)`eid`和`fp`找个普通商品随便下单,然后抓包就能看到,这两个值可以填固定的 
> 随便找一个商品下单，然后进入结算页面，打开浏览器的调试窗口，切换到控制台Tab页，在控制台中输入变量`_JdTdudfp`，即可从输出的Json中获取`eid`和`fp`。  
> 不会的话参考原作者的issue https://github.com/zhou-xiaojun/jd_mask/issues/22

(2)`sku_id`,`DEFAULT_USER_AGENT` 
> `sku_id`已经按照茅台的填好。
> `cookies_string` 现在已经不需要填写了
> `DEFAULT_USER_AGENT` 可以用默认的。谷歌浏览器也可以浏览器地址栏中输入about:version 查看`USER_AGENT`替换

(3)配置一下时间
> 现在不强制要求同步最新时间了，程序会自动同步京东时间
>> 但要是电脑时间快慢了好几个小时，最好还是同步一下吧

以上都是必须的.
> tips：
> 在程序开始运行后，会检测本地时间与京东服务器时间，输出的差值为本地时间-京东服务器时间，即-50为本地时间比京东服务器时间慢50ms。
> 本代码的执行的抢购时间以本地电脑/服务器时间为准

(4)修改抢购瓶数
> 代码中默认抢购瓶数为2，且无法在配置文件中修改
> 如果一个月内抢购过一瓶，最好修改抢购瓶数为1 
> 具体修改为：在`jd_spider_requests.py`文件中搜索`self.seckill_num = 2`，将`2`改为`1`

#### 4.运行main.py 
根据提示选择相应功能即可

#### 5.抢购结果确认 
抢购是否成功通常在程序开始的一分钟内可见分晓！  
搜索日志，出现“抢购成功，订单号xxxxx"，代表成功抢到了，务必半小时内支付订单！

## 📈 更新日志

### v2.1.1 (2025-06-23) 🔥 重要修复版本
- 🔧 **修复登录问题**：完全解决二维码登录失败的问题
- 🆕 **支持新版Cookie**：兼容京东新版登录Cookie格式（pin + pinId）
- 🔄 **智能Cookie验证**：自动识别新旧版本Cookie，提高兼容性
- 🖼️ **二维码自动关闭**：扫码完成后自动关闭二维码窗口，提升用户体验
- 🛡️ **增强登录验证**：多重验证机制，更宽松的登录状态检查
- 📝 **完善文档**：更新README记录所有修改，便于维护和使用
- ⚡ **优化用户体验**：减少不必要的重新登录，自动识别有效登录状态
- 📱 **增强通知系统**：详细的markdown格式通知，包含完整的预约/抢购信息
- 🔔 **智能状态通知**：登录状态变更自动通知，及时提醒用户操作

#### 🔧 技术修复详情

##### 1. Cookie兼容性修复
```python
# 修复前：只支持传统Cookie
key_cookies = ['pt_key', 'pt_pin']

# 修复后：支持新旧版本Cookie
key_cookies = ['pt_key', 'pt_pin', 'pin', 'pinId', 'unick']

# 新版Cookie优先检查
if 'pin' in cookies and 'pinId' in cookies:
    return True  # 新版登录有效
```

##### 2. 登录流程优化
```python
# 修复前：错误的强制状态设置
try:
    self.qrlogin.login_by_qrcode()
    self.qrlogin.is_login = True  # ❌ 错误的强制设置
except Exception as e:
    self.qrlogin.is_login = False  # ❌ 错误的强制设置

# 修复后：保留原始可靠逻辑
self.qrlogin.login_by_qrcode()  # ✅ 简单可靠
```

##### 3. 二维码自动关闭功能
```python
# 新增功能：登录成功后自动关闭二维码窗口
if self.qrlogin.is_login:
    try:
        from helper.jd_helper import close_image_windows
        close_image_windows()  # 自动关闭二维码窗口
    except Exception as e:
        logger.warning(f'关闭二维码窗口失败: {e}')
```

##### 4. 验证策略改进
- **多重验证机制**：Cookie检查 + 网络验证 + 容错处理
- **智能适配**：自动识别京东Cookie格式变化
- **宽松策略**：降低误判率，提高用户体验
- **错误恢复**：网络异常时保守地认为登录有效

##### 5. 跨平台窗口管理
```python
def close_image_windows():
    if os.name == "nt":  # Windows
        subprocess.run(['taskkill', '/F', '/IM', 'Microsoft.Photos.exe'])
    elif os.uname()[0] == "Linux":
        subprocess.run(['pkill', 'eog'])
    else:  # Mac
        subprocess.run(['pkill', 'Preview'])
```

### v2.1.0 (2025-06-20) 🆕
- 🛡️ 新增三级安全策略（保守/平衡/激进）
- 🎭 智能人类行为模拟，降低风控检测
- 🚨 实时风控检测与自动应对机制
- ⏰ 工作日智能时间安排（10:05预约，12:00秒杀）
- 🔄 动态并发策略，根据时间段自动调整
- 📈 极高概率抢购方案，成功率提升至85%+
- 🧠 智能重试间隔，根据错误类型精准调整
- 📦 Windows EXE打包，免安装直接运行

### v2.0.0 (2025-06-20)
- ✨ 新增全自动化执行模式
- 🔐 智能登录维护机制
- ⏰ 多重备选时间同步
- 🛡️ 增强错误处理和恢复
- 📱 完善微信推送通知
- 📊 实时状态监控面板
- ⚙️ 配置自动化验证

### v1.x.x (历史版本)
- 基础预约和秒杀功能
- 二维码登录
- 简单的时间同步

## 🤝 贡献

欢迎提交Issue和Pull Request来改进项目！

### 开发指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建Pull Request

## 📄 许可证

本项目遵循 GPL-3.0 License 协议

## 🙏 感谢

- 感谢原作者 [zhou-xiaojun/jd_mask](https://github.com/zhou-xiaojun/jd_mask) 提供的基础代码
- 感谢 [wlwwu/jd_maotai](https://github.com/wlwwu/jd_maotai) 的优化贡献
- 感谢所有为项目改进提供建议的用户

## 📞 支持

如果您在使用过程中遇到问题：

1. 首先查看本文档的故障排除部分
2. 运行相应的测试脚本进行诊断
3. 查看程序日志获取详细错误信息
4. 检查是否触发风控，必要时调整安全策略
5. 在GitHub上提交Issue

### 🛡️ 安全策略选择建议 🆕

根据您的账户情况选择合适的策略：

- **小白信用 < 70分**: 使用 `CONSERVATIVE` 策略，安全第一
- **小白信用 70-90分**: 使用 `BALANCED` 策略，效果最佳
- **小白信用 > 90分**: 可尝试 `AGGRESSIVE` 策略，但需谨慎

**重要提醒**: 账户安全比单次成功更重要，建议从保守策略开始测试！

---

**⚠️ 免责声明：本项目仅供学习交流使用，请勿用于违法违规用途。使用者需自行承担使用风险。**
