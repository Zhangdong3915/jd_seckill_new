# 安全功能使用指南

本文档介绍京东茅台秒杀系统v2.1.1版本新增的安全功能。

## 🔒 安全功能概述

### 1. 设备指纹自动获取
- **eid参数**: 设备标识，登录后自动收集更新
- **fp参数**: 设备指纹，登录后自动收集更新
- **自动更新**: 无需手动配置，系统自动维护

### 2. 敏感信息安全存储
- **支付密码**: 支持环境变量和加密存储
- **Server酱密钥**: 支持环境变量和加密存储
- **多重保护**: 环境变量 > 加密配置 > 用户输入

## 🚀 使用方法

### 设备指纹自动获取

**无需任何配置！** 系统会在登录成功后自动：

1. 从登录页面收集设备参数
2. 从订单页面收集设备参数
3. 从购物车页面收集设备参数
4. 从cookies中提取设备参数
5. 自动更新config.ini文件

**日志示例**：
```
🔍 正在收集设备指纹参数...
✅ 从Cookie获取eid: AESXKQVW12345...
✅ 从Cookie获取fp: abcdef123456...
✅ 更新设备参数 eid: AESXKQVW12345...
✅ 更新设备参数 fp: abcdef123456...
✅ 设备参数已自动更新到配置文件
```

### 支付密码安全配置

#### 方法1: 环境变量（推荐）

**Windows**:
```cmd
set JD_PAYMENT_PWD=123456
```

**Linux/Mac**:
```bash
export JD_PAYMENT_PWD=123456
```

**永久设置**:
- Windows: 在系统环境变量中添加
- Linux/Mac: 在 ~/.bashrc 或 ~/.zshrc 中添加

#### 方法2: 首次运行输入

1. 运行程序
2. 系统提示输入支付密码
3. 输入后自动加密保存到配置文件
4. 下次运行自动读取

**交互示例**:
```
⚠️ 需要配置 payment_pwd
💡 提示：可以设置环境变量 JD_PAYMENT_PWD 来避免每次输入
请输入京东支付密码（6位数字）: ******
✅ payment_pwd 已加密保存到配置文件
```

#### 方法3: 配置文件直接填写（不推荐）

在config.ini中直接填写：
```ini
[account]
payment_pwd = "123456"
```

### Server酱密钥安全配置

#### 方法1: 环境变量（推荐）

**Windows**:
```cmd
set JD_SCKEY=SCT123456ABCDEF
```

**Linux/Mac**:
```bash
export JD_SCKEY=SCT123456ABCDEF
```

#### 方法2: 首次运行输入

1. 运行程序
2. 系统提示输入SCKEY
3. 输入后自动加密保存

**交互示例**:
```
⚠️ 需要配置 sckey
💡 提示：可以设置环境变量 JD_SCKEY 来避免每次输入
请输入Server酱SCKEY（用于微信通知）: SCT123456ABCDEF
✅ sckey 已加密保存到配置文件
```

## 🔐 安全机制

### 加密算法
- **算法**: AES-256 (Fernet)
- **密钥生成**: PBKDF2-HMAC-SHA256
- **机器绑定**: 基于机器特征生成密钥
- **盐值**: 固定盐值确保一致性

### 优先级顺序
1. **环境变量**: 最高优先级，适合CI/CD环境
2. **加密配置**: 中等优先级，本地加密存储
3. **用户输入**: 最低优先级，交互式输入

### 安全特性
- ✅ **机器绑定**: 配置文件只能在当前机器解密
- ✅ **自动加密**: 敏感信息自动加密存储
- ✅ **环境变量**: 支持无配置文件部署
- ✅ **向后兼容**: 兼容原有明文配置

## 📋 配置文件变化

### 新的config.ini格式

```ini
[config]
# eid, fp参数 - 现在支持自动获取更新！
# 登录成功后系统会自动收集并更新这些参数
eid = "自动更新"
fp = "自动更新"

[account]
# 支付密码 - 现在支持安全存储！
# 优先级：环境变量 JD_PAYMENT_PWD > 加密配置文件 > 用户输入
payment_pwd = ""

[messenger]
# Server酱密钥 - 现在支持安全存储！
# 优先级：环境变量 JD_SCKEY > 加密配置文件 > 用户输入
sckey = ""
```

## 🛠️ 故障排除

### 设备指纹收集失败
```
⚠️ 设备指纹收集不完整，将使用默认值
```

**解决方案**:
1. 确保网络连接正常
2. 检查登录状态是否有效
3. 手动在config.ini中填写eid和fp

### 加密解密失败
```
❌ 获取安全值失败
```

**解决方案**:
1. 删除config.ini中的加密值，重新输入
2. 检查机器环境是否发生变化
3. 使用环境变量方式配置

### 环境变量不生效
```
⚠️ 环境变量未找到，使用配置文件
```

**解决方案**:
1. 确认环境变量名称正确（JD_PAYMENT_PWD, JD_SCKEY）
2. 重启命令行或IDE
3. 检查环境变量是否正确设置

## 📊 使用建议

### 个人用户
- 使用**首次输入**方式，简单方便
- 系统自动加密保存，安全可靠

### 企业用户
- 使用**环境变量**方式，便于管理
- 支持CI/CD自动化部署

### 开发者
- 使用**环境变量**方式，避免敏感信息泄露
- 配置文件可以安全提交到版本控制

## 🔄 迁移指南

### 从旧版本升级

1. **备份配置**: 备份原有config.ini
2. **更新代码**: 拉取最新代码
3. **安装依赖**: `pip install cryptography`
4. **首次运行**: 系统会自动处理配置迁移

### 配置迁移
- 原有明文配置继续有效
- 首次运行时会提示是否加密存储
- 设备参数会自动更新

---

通过这些安全功能，您的京东茅台秒杀系统将更加安全可靠！
